{"version":3,"file":"reactivity.esm-bundler.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts","../src/ref.ts"],"sourcesContent":["export function isObject(value){\n    return typeof value === 'object' && value !== null\n}\n\nexport function extend(...args){\n    return Object.assign({}, ...args)\n}\n\nexport const isArray = Array.isArray\n\nexport function hasChanged(oldValue, newValue) {\n    return oldValue !== newValue\n}\n\nexport function isIntegerKey(key){\n    return parseInt(key) + '' === key\n}\n\nexport const hasOwn = (target, key) => Object.prototype.hasOwnProperty.call(target, key)","import { isArray, isIntegerKey } from \"@vue/shared\"\n\nexport function effect(fn, options:any = {}){\n    const effect = createReactiveEffect(fn, options)\n\n    !options.lazy && effect()\n\n    return effect\n}\nconst targetMap = new WeakMap()\nexport function track(target,type,key){\n\n    if(activeEffect === undefined) return\n\n    let depsMap = targetMap.get(target)\n    if(!depsMap) targetMap.set(target, (depsMap = new Map()))\n\n    let dep = depsMap.get(key)\n    if(!dep) depsMap.set(key, (dep = new Set()))\n\n    !dep.has(activeEffect) && dep.add(activeEffect)\n\n}\n\nexport function trigger(target,type,key,newValue,oldValue?){\n\n    const depsMap = targetMap.get(target)\n    if( !depsMap ) return\n\n    const effects = new Set()\n    function addEffect(effectSet){\n        effectSet && effectSet.forEach(effect => effects.add(effect))\n    }\n\n    if(isArray(target) && key === 'length'){\n        depsMap.forEach((dep, key) => {\n            key > newValue || key === 'length' && addEffect(dep)\n        })\n    } else {\n        addEffect(depsMap.get(key))\n        switch (type){\n            case 'add':\n                isArray(target) && isIntegerKey(key) && addEffect(depsMap.get('length'))\n        }\n    }\n\n    effects.forEach((effect:any) => effect())\n\n}\n\nlet activeEffect\nlet id = 0\nconst effectStack = []\nfunction createReactiveEffect(fn, options){\n    const effect = function reactiveEffect() {\n        try{\n            effectStack.push(effect)\n            activeEffect = effect\n            return fn()\n        }finally{\n            effectStack.pop()\n            activeEffect = effectStack.at(-1)\n        }\n    }\n    effect.id = id++\n    effect.__isEffect = true\n    effect.options = options\n    effect.deps = []\n    return effect\n}","import { extend, hasChanged, hasOwn, isArray, isIntegerKey, isObject } from \"@vue/shared\"\nimport { reactive, readonly } from \".\"\nimport { track, trigger } from \"./effect\"\n\nconst get = createGetter()\nconst shallowReactiveGet = createGetter(false, true)\nconst readonlyGet = createGetter(true)\nconst shallowReadonlyGet = createGetter(true, true)\n\nconst set = createSetter()\nconst shallowSet = createSetter(true)\nexport const mutableHandlers = {\n    get,\n    set\n}\nexport const shallowReactiveHandlers = {\n    get: shallowReactiveGet,\n    set: shallowSet\n}\n\nconst readonlySet = {\n    set(target, key){\n        console.warn(`cannot set ${JSON.stringify(target)} on key ${key} failed!`)\n    }\n}\nexport const readonlyHandlers = extend({\n    get: readonlyGet,\n}, readonlySet)\nexport const shallowReadonlyHandlers = extend({\n    get: shallowReadonlyGet\n}, readonlySet)\n\n\n\nfunction createGetter(isReadonly = false, shallow = false) {\n    return function get(target, key, reactiver){\n\n        const result = Reflect.get(target, key, reactiver)\n        \n        if(!isReadonly) {\n            track(target,'get',key)\n        }\n\n        if(shallow) return result\n\n        if(isObject(result)){\n            return isReadonly ? readonly(result) : reactive(result)\n        }\n\n        return result\n    }\n}\n\nfunction createSetter(shallow = false) {\n    return function set(target, key, value, reactiver){\n        const oldValue = target[key]\n        const hasKey = isArray(target) && isIntegerKey(key) ? Number(key) < target.length : hasOwn(target, key)\n        const result = Reflect.set(target, key, value, reactiver)\n        if(!hasKey){\n            trigger(target,'add',key,value,oldValue)\n        }else if(hasChanged(oldValue, value)){\n            trigger(target,'set',key,value,oldValue)\n        }\n        return result\n    }\n}","import { isObject } from \"@vue/shared\"\nimport { mutableHandlers, readonlyHandlers, shallowReactiveHandlers, shallowReadonlyHandlers } from \"./baseHandlers\"\n\n\nexport function reactive(target){\n    return createReactiveObject(target, false, mutableHandlers)\n}\n\nexport function shallowReactive(target){\n    return createReactiveObject(target, false, shallowReactiveHandlers)\n}\n\n\nexport function readonly(target){\n    return createReactiveObject(target, true, readonlyHandlers)\n}\n\n\nexport function shallowReadonly(target){\n    return createReactiveObject(target, true, shallowReadonlyHandlers)\n}\n\nconst reactiveMap = new WeakMap()\nconst readonlyMap = new WeakMap()\nfunction createReactiveObject(target, isReadonly, baseHandlers){\n    if(!isObject(target)) return target\n    /**\n     * target 创建的目标对象\n     * isReadonly 当前对象是否是仅读\n     * baseHandlers 针对不同方式创建代理对象\n     */\n    const proxyMap = isReadonly ? readonlyMap : reactiveMap\n    const existProxy = proxyMap.get(target)\n    if(existProxy) return existProxy\n    const proxy = new Proxy(target, baseHandlers)\n    proxyMap.set(target, proxy)\n    return proxy\n}","import { hasChanged, isObject } from \"@vue/shared\"\nimport { reactive } from \".\"\nimport { track, trigger } from \"./effect\"\n\nexport function ref(value) {\n    return createRef(value)\n}\n\nexport function shallowRef(value) {\n    return createRef(value, true)\n}\n\nconst convert = value => isObject(value) ? reactive(value) : value\nclass RefImpl{\n    public _value\n    public __v_isRef = true\n    constructor(public rawValue, public shallow) {\n        this._value = shallow ? rawValue : convert(rawValue)\n        this.shallow = shallow\n    }\n\n    get value() {\n        track(this, 'get', 'value')\n        return this._value\n    }\n\n    set value(newValue) {\n        if(hasChanged(newValue, this.rawValue)){\n            this.rawValue = newValue\n            this._value = this.shallow ? newValue : convert(newValue)\n            trigger(this, 'set', 'value', newValue)\n        }\n    }\n}\n\nfunction createRef(value, shallow = false){\n    return new RefImpl(value, shallow)\n}"],"names":[],"mappings":"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"}