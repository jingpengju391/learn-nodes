{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts","../src/ref.ts"],"sourcesContent":["export function isObject(value){\n    return typeof value === 'object' && value !== null\n}\n\nexport function extend(...args){\n    return Object.assign({}, ...args)\n}\n\nexport const isArray = Array.isArray\n\nexport function hasChanged(oldValue, newValue) {\n    return oldValue !== newValue\n}\n\nexport function isIntegerKey(key){\n    return parseInt(key) + '' === key\n}\n\nexport const hasOwn = (target, key) => Object.prototype.hasOwnProperty.call(target, key)","import { isArray, isIntegerKey } from \"@vue/shared\"\n\nexport function effect(fn, options:any = {}){\n    const effect = createReactiveEffect(fn, options)\n\n    !options.lazy && effect()\n\n    return effect\n}\nconst targetMap = new WeakMap()\nexport function track(target,type,key){\n\n    if(activeEffect === undefined) return\n\n    let depsMap = targetMap.get(target)\n    if(!depsMap) targetMap.set(target, (depsMap = new Map()))\n\n    let dep = depsMap.get(key)\n    if(!dep) depsMap.set(key, (dep = new Set()))\n\n    !dep.has(activeEffect) && dep.add(activeEffect)\n\n}\n\nexport function trigger(target,type,key,newValue,oldValue?){\n\n    const depsMap = targetMap.get(target)\n    if( !depsMap ) return\n\n    const effects = new Set()\n    function addEffect(effectSet){\n        effectSet && effectSet.forEach(effect => effects.add(effect))\n    }\n\n    if(isArray(target) && key === 'length'){\n        depsMap.forEach((dep, key) => {\n            key > newValue || key === 'length' && addEffect(dep)\n        })\n    } else {\n        addEffect(depsMap.get(key))\n        switch (type){\n            case 'add':\n                isArray(target) && isIntegerKey(key) && addEffect(depsMap.get('length'))\n        }\n    }\n\n    effects.forEach((effect:any) => effect())\n\n}\n\nlet activeEffect\nlet id = 0\nconst effectStack = []\nfunction createReactiveEffect(fn, options){\n    const effect = function reactiveEffect() {\n        try{\n            effectStack.push(effect)\n            activeEffect = effect\n            return fn()\n        }finally{\n            effectStack.pop()\n            activeEffect = effectStack.at(-1)\n        }\n    }\n    effect.id = id++\n    effect.__isEffect = true\n    effect.options = options\n    effect.deps = []\n    return effect\n}","import { extend, hasChanged, hasOwn, isArray, isIntegerKey, isObject } from \"@vue/shared\"\nimport { reactive, readonly } from \".\"\nimport { track, trigger } from \"./effect\"\n\nconst get = createGetter()\nconst shallowReactiveGet = createGetter(false, true)\nconst readonlyGet = createGetter(true)\nconst shallowReadonlyGet = createGetter(true, true)\n\nconst set = createSetter()\nconst shallowSet = createSetter(true)\nexport const mutableHandlers = {\n    get,\n    set\n}\nexport const shallowReactiveHandlers = {\n    get: shallowReactiveGet,\n    set: shallowSet\n}\n\nconst readonlySet = {\n    set(target, key){\n        console.warn(`cannot set ${JSON.stringify(target)} on key ${key} failed!`)\n    }\n}\nexport const readonlyHandlers = extend({\n    get: readonlyGet,\n}, readonlySet)\nexport const shallowReadonlyHandlers = extend({\n    get: shallowReadonlyGet\n}, readonlySet)\n\n\n\nfunction createGetter(isReadonly = false, shallow = false) {\n    return function get(target, key, reactiver){\n\n        const result = Reflect.get(target, key, reactiver)\n        \n        if(!isReadonly) {\n            track(target,'get',key)\n        }\n\n        if(shallow) return result\n\n        if(isObject(result)){\n            return isReadonly ? readonly(result) : reactive(result)\n        }\n\n        return result\n    }\n}\n\nfunction createSetter(shallow = false) {\n    return function set(target, key, value, reactiver){\n        const oldValue = target[key]\n        const hasKey = isArray(target) && isIntegerKey(key) ? Number(key) < target.length : hasOwn(target, key)\n        const result = Reflect.set(target, key, value, reactiver)\n        if(!hasKey){\n            trigger(target,'add',key,value,oldValue)\n        }else if(hasChanged(oldValue, value)){\n            trigger(target,'set',key,value,oldValue)\n        }\n        return result\n    }\n}","import { isObject } from \"@vue/shared\"\nimport { mutableHandlers, readonlyHandlers, shallowReactiveHandlers, shallowReadonlyHandlers } from \"./baseHandlers\"\n\n\nexport function reactive(target){\n    return createReactiveObject(target, false, mutableHandlers)\n}\n\nexport function shallowReactive(target){\n    return createReactiveObject(target, false, shallowReactiveHandlers)\n}\n\n\nexport function readonly(target){\n    return createReactiveObject(target, true, readonlyHandlers)\n}\n\n\nexport function shallowReadonly(target){\n    return createReactiveObject(target, true, shallowReadonlyHandlers)\n}\n\nconst reactiveMap = new WeakMap()\nconst readonlyMap = new WeakMap()\nfunction createReactiveObject(target, isReadonly, baseHandlers){\n    if(!isObject(target)) return target\n    /**\n     * target 创建的目标对象\n     * isReadonly 当前对象是否是仅读\n     * baseHandlers 针对不同方式创建代理对象\n     */\n    const proxyMap = isReadonly ? readonlyMap : reactiveMap\n    const existProxy = proxyMap.get(target)\n    if(existProxy) return existProxy\n    const proxy = new Proxy(target, baseHandlers)\n    proxyMap.set(target, proxy)\n    return proxy\n}","import { hasChanged, isObject } from \"@vue/shared\"\nimport { reactive } from \".\"\nimport { track, trigger } from \"./effect\"\n\nexport function ref(value) {\n    return createRef(value)\n}\n\nexport function shallowRef(value) {\n    return createRef(value, true)\n}\n\nconst convert = value => isObject(value) ? reactive(value) : value\nclass RefImpl{\n    public _value\n    public __v_isRef = true\n    constructor(public rawValue, public shallow) {\n        this._value = shallow ? rawValue : convert(rawValue)\n        this.shallow = shallow\n    }\n\n    get value() {\n        track(this, 'get', 'value')\n        return this._value\n    }\n\n    set value(newValue) {\n        if(hasChanged(newValue, this.rawValue)){\n            this.rawValue = newValue\n            this._value = this.shallow ? newValue : convert(newValue)\n            trigger(this, 'set', 'value', newValue)\n        }\n    }\n}\n\nfunction createRef(value, shallow = false){\n    return new RefImpl(value, shallow)\n}"],"names":[],"mappings":"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"}